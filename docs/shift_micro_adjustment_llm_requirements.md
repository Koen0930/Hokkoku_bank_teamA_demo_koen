# シフト微調整LLM統合機能 要件定義書

## 1. 概要

### 1.1 目的
既存のLLM統合機能とチャット微調整機能を最大限活用し、シフト微調整LLM統合機能を効率的に実装する。

### 1.2 背景
- 既存のLLM統合機能（意図判定、制約変更生成）の活用
- 既存のチャット微調整機能（名前抽出、ルール正規化）の拡張
- 既存の調整機能（プレビュー生成、適用・ロールバック）の活用
- 最適化済みシフト結果の後調整ニーズ
- 自然言語での直感的なシフト調整
- 再最適化を避けた軽量な調整処理

### 1.3 スコープ
- **含む**: 既存LLM統合機能の拡張、既存チャット微調整機能の拡張、シフト微調整、自然言語解析
- **含まない**: 制約条件変更、再最適化、大規模なシフト変更、既存機能の大幅な変更

### 1.4 既存実装との統合方針
- **既存LLM基盤の活用**: `openai_client.py`の意図判定・JSON生成機能を拡張
- **既存チャット機能の活用**: `chat.py`の名前抽出・ルール正規化機能を拡張
- **既存調整機能の活用**: `adjustments.py`のプレビュー生成・適用機能を拡張
- **既存UI基盤の活用**: `MicroAdjustments.tsx`のチャットUIを拡張
- **既存セッション管理の活用**: `store.py`のセッション機能をそのまま使用
- **既存WebSocket通信の活用**: `adjustments_ws.py`のリアルタイム機能を拡張

## 2. 機能要件

### 2.1 基本機能

#### F-001: 自然言語入力受付
- **概要**: ユーザーが自然言語でシフト調整指示を入力
- **入力例**: 
  - 「AさんとBさんを同時に入れないで」
  - 「水曜の人数をもっと増やして」
  - 「シフトが少ない人のシフトを増やして」
- **要件**: 日本語対応、曖昧表現の解消

#### F-002: 意図判定
- **概要**: 既存のLLM意図判定機能を拡張し、入力が質問か調整指示かを自動判定
- **既存機能活用**: `openai_client.py`の`detect_intent()`を拡張
- **判定基準**:
  - **質問**: 「どうすれば」「なぜ」「説明して」等
  - **調整**: 「〜して」「〜を変更して」「〜を増やして」等
- **信頼度**: 0.7以上で調整指示と判定
- **拡張内容**: 既存のqa/apply判定に調整判定を追加

#### F-003: シフト調整ルール生成
- **概要**: 既存のLLM制約変更生成機能を拡張し、自然言語から調整ルールを生成
- **既存機能活用**: `openai_client.py`の`generate_apply()`を拡張
- **ルールタイプ**:
  - `pair_not_together`: 2人の同時配置禁止（既存機能を活用）
  - `increase_staff_day`: 特定日の人員増加（新規追加）
  - `redistribute_shifts`: シフト再配分（新規追加）
  - `time_slot_adjustment`: 時間帯調整（新規追加）
- **拡張内容**: 既存の制約変更生成に調整ルール生成を追加

#### F-004: 調整案プレビュー
- **概要**: 既存の調整機能を活用し、生成されたルールに基づく調整案を表示
- **既存機能活用**: `adjustments.py`のプレビュー生成機能を拡張
- **表示内容**:
  - 変更前後のシフト比較
  - 変更箇所のハイライト
  - 影響範囲の説明
- **拡張内容**: 既存のpair_not_together調整に新ルールタイプを追加

#### F-005: 調整適用
- **概要**: 既存の調整機能を活用し、承認された調整案をシフトに適用
- **既存機能活用**: `adjustments.py`の適用・ロールバック機能をそのまま使用
- **機能**: 
  - 調整の実行
  - 監査ログ記録
  - リアルタイム反映
- **拡張内容**: 既存の適用機能に新ルールタイプを対応

### 2.2 詳細機能

#### F-006: 質問回答機能
- **概要**: 既存のLLM質問回答機能を活用し、シフトに関する質問に自然言語で回答
- **既存機能活用**: `openai_client.py`の`generate_qa()`をそのまま使用
- **対応質問**:
  - 「なぜこのシフトになったの？」
  - 「Aさんのシフトはどうなってる？」
  - 「水曜の人員は何人？」
- **拡張内容**: 既存の質問回答機能にシフト関連の質問を対応

#### F-007: 調整ルール検証
- **概要**: 既存の検証機能を活用し、生成されたルールの妥当性を検証
- **既存機能活用**: `validation.py`の検証機能を拡張
- **検証項目**:
  - ルールの構文チェック
  - 制約違反の確認
  - 実現可能性の判定
- **拡張内容**: 既存の制約検証に調整ルール検証を追加

#### F-008: 調整履歴管理
- **概要**: 既存のセッション管理機能を活用し、調整操作の履歴を保存・管理
- **既存機能活用**: `store.py`のセッション管理機能をそのまま使用
- **保存内容**:
  - 調整指示内容
  - 生成されたルール
  - 適用結果
  - 操作者情報
- **拡張内容**: 既存のセッション管理に調整履歴を追加

## 3. 非機能要件

### 3.1 性能要件
- **応答時間**: 意図判定 ≤ 2秒、調整案生成 ≤ 5秒
- **同時利用者数**: 10人以上
- **処理能力**: 1日100回以上の調整処理

### 3.2 可用性要件
- **稼働率**: 99%以上
- **障害復旧**: 5分以内
- **データ保持**: 調整履歴1年間

### 3.3 セキュリティ要件
- **認証**: ユーザー認証必須
- **認可**: 調整権限の管理
- **監査**: 全操作のログ記録

## 4. ユーザーインターフェース

### 4.1 チャットUI
- **既存機能活用**: `MicroAdjustments.tsx`のチャットUIを拡張
- **レイアウト**: 2ペイン構成（チャット + シフト表示）
- **入力**: テキストエリア + 送信ボタン
- **表示**: メッセージ履歴、ローディング状態
- **拡張内容**: 既存のチャットUIにLLM統合機能を追加

### 4.2 プレビューUI
- **既存機能活用**: `MicroAdjustments.tsx`のプレビューUIをそのまま使用
- **シフト表示**: 変更前後の比較表示
- **ハイライト**: 変更箇所の視覚的強調
- **操作**: 適用/キャンセルボタン
- **拡張内容**: 既存のプレビューUIに新ルールタイプを対応

## 5. データモデル

### 5.1 調整ルール
```json
{
  "type": "pair_not_together|increase_staff_day|redistribute_shifts|time_slot_adjustment",
  "parameters": {
    "employee_ids": [1, 2],
    "day": "wednesday",
    "time_slot": "morning",
    "target_count": 3
  },
  "priority": "high|medium|low",
  "description": "ルールの説明"
}
```

### 5.2 調整セッション
```json
{
  "session_id": "uuid",
  "user_id": "user123",
  "created_at": "2025-08-18T10:00:00Z",
  "messages": [
    {
      "role": "user|assistant",
      "content": "メッセージ内容",
      "intent": "qa|adjust",
      "confidence": 0.95,
      "rule": {...}
    }
  ]
}
```

## 6. 外部インターフェース

### 6.1 LLM API
- **既存機能活用**: `openai_client.py`の既存LLM統合機能を拡張
- **プロバイダ**: OpenAI GPT-4o-mini
- **機能**: 意図判定、ルール生成、質問回答
- **制限**: トークン数制限、レート制限
- **拡張内容**: 既存のLLM統合に調整機能を追加

### 6.2 シフト管理API
- **既存機能活用**: 既存のシフト管理APIをそのまま使用
- **機能**: シフト取得、更新、検証
- **形式**: REST API
- **認証**: API Key
- **拡張内容**: 既存のシフト管理APIに調整機能を追加

## 7. 制約事項

### 7.1 技術制約
- **既存機能との整合性**: 既存のLLM統合機能との競合を避ける
- **既存コードの保護**: 既存機能の動作を維持する
- **LLM応答時間**: 外部API依存のため応答時間に変動あり
- **トークン制限**: 入力・出力の長さ制限
- **コスト**: API使用料の発生

### 7.2 業務制約
- **調整範囲**: 既存シフトの微調整のみ
- **承認フロー**: 管理者承認が必要な場合あり
- **ロールバック**: 直前の調整のみ戻し可能
- **既存機能の維持**: 既存のチャット微調整機能の動作を維持する

## 8. 受入基準

### 8.1 機能受入基準
- [ ] 既存のLLM統合機能が正常に動作する
- [ ] 既存のチャット微調整機能が正常に動作する
- [ ] 自然言語入力でシフト調整が可能
- [ ] 意図判定の精度が80%以上
- [ ] 調整案の生成が5秒以内
- [ ] 調整の適用が正常に動作
- [ ] 質問回答が適切に機能

### 8.2 性能受入基準
- [ ] 意図判定が2秒以内
- [ ] 調整案生成が5秒以内
- [ ] 同時10ユーザーでの動作
- [ ] エラー率5%以下

### 8.3 品質受入基準
- [ ] 調整ルールの検証が正常動作
- [ ] 監査ログが適切に記録
- [ ] セキュリティ要件を満たす
- [ ] ユーザビリティテストを通過
